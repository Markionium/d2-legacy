"use strict";
/*
 * Copyright (c) 2004-2014, University of Oslo
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are met:
 * Redistributions of source code must retain the above copyright notice, this
 * list of conditions and the following disclaimer.
 *
 * Redistributions in binary form must reproduce the above copyright notice,
 * this list of conditions and the following disclaimer in the documentation
 * and/or other materials provided with the distribution.
 * Neither the name of the HISP project nor the names of its contributors may
 * be used to endorse or promote products derived from this software without
 * specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND
 * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
 * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
 * DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR
 * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
 * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
 * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON
 * ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
 * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */
(function (angular, undefined) {
    var d2,d2Auth,d2Services,d2Filters,d2RecordTable,d2ContextMenu,d2Config;d2={scriptPath:function(){var e;return function(){var d,r,a;return e?e:(a=angular.element('<script src=""></script>'),d=document.getElementsByTagName("script"),angular.forEach(d,function(e){/d2(\.min)?\.js$/i.test(e.src)&&(a=e)}),r=a.src||"",e=r.substring(0,r.lastIndexOf("/")+1))}}()},d2Config=angular.module("d2-config",[]),angular.module("d2-rest",["restangular"]),d2Auth=angular.module("d2-auth",["d2-rest"]),angular.module("d2-translate",["pascalprecht.translate","d2-config"]),d2ContextMenu=angular.module("d2-contextmenu",[]),d2RecordTable=angular.module("d2-recordtable",["d2-filters","d2-typeahead","ui.bootstrap.tpls","ui.bootstrap.pagination"]),angular.module("d2-breadcrumbs",[]),d2Filters=angular.module("d2-filters",[]),angular.module("d2-directives",["d2-breadcrumbs","d2-introlist","d2-headerbar","d2-recordtable","d2-detailsbox"]),d2Services=angular.module("d2-services",["d2-auth"]),angular.module("d2",["d2-services","d2-directives","d2-filters"]);
angular.module("d2-auth").service("currentUser",["d2Api",function(e){var n,t,s=this;this.userLoaded=!1,this.permissionsLoaded=!1,this.getPermissions=function(){return n},this.hasPermission=function(e){return t.indexOf(e)>0?!0:!1},e.currentUser.get().then(function(e){angular.extend(s,e.getDataOnly())}),n=e.currentUser.permissions.getList().then(function(e){return s.permissionsLoaded=!0,t=e.getDataOnly()})}]);
angular.module("d2-breadcrumbs").directive("breadCrumbs",function(){return{restrict:"E",replace:!0,scope:{homeCrumb:"="},templateUrl:d2.scriptPath()+"common/breadcrumbs/breadcrumbs.html",controller:["$scope","$location","breadCrumbsService",function(r,c,e){r.crumbClick=function(r){e.resetCrumbs(r.id),r.click&&r.click(angular.copy(r))},r.$watchCollection(function(){return e.getCrumbsList()},function(c){r.crumbsList=c})}]}});
angular.module("d2-breadcrumbs").service("breadCrumbsService",function(){var i=[];this.crumbsList=[],this.addCrumb=function(i,t){var s={};angular.isString(i)&&""!==i&&(s.name=i,s.id=this.crumbsList.length,t&&angular.isFunction(t)&&(s.click=function(){return t()}),this.crumbsList.push(s))},this.resetCrumbs=function(i){void 0===i&&(this.crumbsList=[]),this.crumbsList=_.filter(this.crumbsList,function(t){return t.id<=i})},this.getCrumbsList=function(){return i.concat(this.crumbsList)},this.addHomeCrumb=function(t,s){var r=this;return i=[],i.push({name:t,click:function(){r.crumbsList=[],angular.isFunction(s)&&s()}}),i[0]}});
d2Config.constant("API_ENDPOINT","/dhis/api"),d2Config.factory("apiConfig",["API_ENDPOINT",function(n){return{getUrl:function(i){if(!angular.isString(i))throw"Api Config Error: Resource URL should be a string";return"/"===i[0]&&(i=i.substr(1)),[n,i].join("/")}}}]);
d2ContextMenu.directive("contextMenu",function(){});
angular.module("d2-detailsbox",[]),angular.module("d2-detailsbox").directive("detailsBox",function(){return{restrict:"EA",replace:!0,scope:{details:"=",headers:"="},templateUrl:d2.scriptPath()+"common/detailsbox/detailsbox.html",controller:["$scope",function(e){var a=this;this.parseDetailsToArray=function(){var a=e.details;angular.isArray(e.headers)&&e.headers.length>0&&(a=_.pick(e.details,e.headers)),e.valueList=_.map(a,function(e,a){return{key:a,value:e}})},this.parseDetailsToArray(),e.$watch("details",function(e,t){e!==t&&a.parseDetailsToArray()})}]}});
angular.module("d2-filters").filter("capitalize",function(){return function(r){return angular.isString(r)?r.charAt(0).toUpperCase()+r.slice(1):r}});
angular.module("d2-filters").filter("translate",["capitalizeFilter",function(t){return function(r){return t(r)}}]);
angular.module("d2-headerbar",[]),angular.module("d2-headerbar").directive("headerBar",function(){return{restrict:"E",replace:!0,transclude:!0,scope:{title:"@",link:"@",logo:"@",hasContent:"@"},templateUrl:d2.scriptPath()+"common/headerbar/headerbar.html",compile:function(e,t){t.title=t.title||"District Health Information Software 2",t.link=t.link||"../dhis-web-dashboard-integration/index.action",t.logo=t.logo||"../dhis-web-commons/css/light_blue/logo_banner.png"}}});
angular.module("d2-introlist",[]),angular.module("d2-introlist").directive("introList",function(){return{restrict:"E",replace:!0,scope:{itemList:"=",itemClick:"&"},templateUrl:d2.scriptPath()+"common/introlist/introlist.html",link:function(t){t.clickFunction=function(i){var n={item:angular.copy(i)};t.itemClick(n)}}}});
d2RecordTable.controller("RecordTableController",["$scope","$q","$filter","$timeout","typeAheadService",function(t,e,a,r,i){var n=this,s=!1;this.localData=!0,this.origData=[],this.typeAheadCache=i,t.items=[],t.pager={},this.getHeadersFromData=function(){var e=[];return _.map(t.items,function(t){var a=t.getDataOnly?t.getDataOnly():t;return _.map(a,function(t,a){e.push({name:a})}),e}),e=_.uniq(e,function(t){return t.name}),t.columns=e,t.columns},this.parseTableConfig=function(){var e=t.tableConfig||{};return t.pageItems=e.pageItems,t.columns=e.columns||void 0,t.rowClick=e.rowClick,this},this.parseTableData=function(){var a;return angular.isArray(t.tableData)&&void 0!==t.tableData.getList?(this.localData=!1,t.d2Service=t.tableData,a=t.d2Service.getList(this.getRemoteParams())):a=t.tableData,e.when(a).then(this.processData.bind(this)),this},this.processData=function(e){return t.items=this.origData=e,t.columns=t.columns||this.getHeadersFromData(),t.pageItems&&(t.items=t.items.slice(0,t.pageItems)),e&&e.meta&&(t.meta=e.meta,this.processMetaData()),angular.forEach(t.columns,function(t){n.typeAheadCache.add(t.name,n.getValuesForColumn(t))}),e&&this.localData&&(t.pager={currentPage:1,resultTotal:e.length,itemsPerPage:t.pageItems}),this},this.processMetaData=function(){this.setUpPager()},this.setUpPager=function(){t.pager.itemsPerPage||(t.pager.itemsPerPage=t.items.length),t.pager.pageCount=t.meta.pager.pageCount,t.pager.resultTotal=t.meta.pager.total,t.pager.currentPage=t.meta.pager.page},this.getCurrentPageParams=function(){return t.pager.currentPage>1?t.pager.currentPage:void 0},this.switchPage=function(){if(this.localData===!0){if(!angular.isNumber(t.pageItems)||!angular.isNumber(t.pager.currentPage))return;t.items=this.origData.slice(t.pageItems*(t.pager.currentPage-1),t.pageItems*t.pager.currentPage)}else this.requestNewDataFromService()},this.setSortOrder=function(e){var a=angular.copy(t.columns);angular.forEach(a,function(t){t.sort=t.name===e.name?"asc"===e.sort?"desc":"asc":void 0}),t.columns=a},this.getColumnsWithFilters=function(){return _.filter(t.columns,"searchable")},this.getFilterObject=function(){var t=this.getColumnsWithFilters(),e={};return 0===t.length?!1:(angular.forEach(t,function(t){e[t.name]=t.filter}),e)},this.getRemoteFilters=function(){var t=[];if(this.getFilterObject())return angular.forEach(this.getFilterObject(),function(e,a){e&&t.push(a+":like:"+e)}),t.length>0?t:void 0},this.getRemoteParams=function(){var t={},e=this.getRemoteFilters(),a=this.getCurrentPageParams();return e&&(t.filter=e),a&&(t.page=a),t},this.requestNewDataFromService=function(){var a=this.getRemoteParams();e.when(t.d2Service.getList(a)).then(this.processData.bind(this))},this.doLocalFiltering=function(){this.getFilterObject()&&(t.items=a("filter")(this.origData,this.getFilterObject()))},this.doLocalSorting=function(){var e,a=_.filter(t.columns,"sort"),r=_.pluck(a,"name");0!==a.length&&(e=_.sortBy(t.items,r),a[0]&&"desc"===a[0].sort&&(e=e.reverse()),t.items=e)},this.serviceSorting=function(){var e=_.filter(t.columns,"sort");0!==e.length&&window.alert("API Sorting not yet implemented")},this.getValuesForColumn=function(e){return e&&e.name&&angular.isString(e.name)?_.map(t.items,function(t){return t[e.name]}):[]},t.$watch("columns",function(e,a){a!==e&&(n.localData&&(n.doLocalFiltering(),n.doLocalSorting()),t.d2Service&&(s||(r(function(){n.requestNewDataFromService(),s=!1},300),s=!0)))},!0),t.$watch("pager.currentPage",function(t,e){e&&t!==e&&n.switchPage()}),t.$watch("tableData",function(t,e){t!==e&&n.parseTableData()})}]);
d2RecordTable.directive("recordTable",function(){return{restrict:"E",replace:!0,scope:{tableConfig:"=",tableData:"="},templateUrl:d2.scriptPath()+"common/recordtable/recordtable.html",controller:"RecordTableController",link:function(e,r,t,a){a.parseTableConfig(),a.parseTableData()}}});
var d2RecordTable=angular.module("d2-recordtable");d2RecordTable.directive("recordTableHeader",function(){return{restrict:"AC",replace:!0,require:"^recordTable",transclude:!0,scope:{column:"="},template:'<th class="table-header"><a ng-click="sortOrder()" href="#" ng-if="column.sortable" ng-transclude ng-class="\'sorting-\' + column.sort" translate></a><span ng-if="!column.sortable" ng-transclude></span><input ng-if="column.searchable" ng-model="column.filter" type="text" typeahead="name for name in getTypeAheadFor(column) | filter:$viewValue | limitTo:8"></th>',link:function(e,r,n,t){e.sortOrder=function(){t.setSortOrder(e.column)},e.getTypeAheadFor=function(e){return t.typeAheadCache[e.name]}}}});
var d2Rest=angular.module("d2-rest");d2Rest.provider("d2Api",["RestangularProvider",function(t){var n=function(){this.indicators=this.all("indicators"),this.currentUser=this.one("me"),this.currentUser.permissions=this.one("me").all("authorization"),this.schemas=this.all("schemas"),this.addEndPoint=function(t,n){if(t.match(/^\//))throw"D2Api Error: EndPoint should not have a leading slash";if(this[t])throw'D2Api Error: EndPoint "'+t+'" already exists';return this[t]=n?this.one(t):this.all(t),this[t]},this.getEndPoint=function(t){if(void 0===this[t])throw"D2Api Error: Endpoint does not exist";return this[t]},this.hasEndPoint=function(t){return this[t]?!0:!1}};this.setBaseUrl=function(t){this.config.setBaseUrl(t)},this.$get=["Restangular",function(t){var r;return r=n,r.prototype=t,new n}],this.config=t,this.config.addResponseInterceptor(function(t,n,r){if("getList"===n&&t&&t[r]){var e=t[r],i=angular.copy(t);return delete i[r],e.meta=i,e}return t}),this.config.setResponseExtractor(function(t){var n=t,r=angular.copy(t);return n.getDataOnly=function(){return r},n}),this.config.setOnElemRestangularized(function(t,n,r,e){return n||t.getDataOnly?t:angular.isString(t)?t:(t.getDataOnly=function(){var n=angular.copy(t);return n=e.stripRestangular(n),delete n.getDataOnly,n},t)})}]),d2Rest.factory("userIsLoggedOutInterceptor",["$window",function(t){return{response:function(n){return n&&"string"==typeof n.data&&n.data.indexOf('<body class="loginPage">')>=0&&t.location.reload(),n}}}]),d2Rest.config(["$httpProvider","d2ApiProvider",function(t,n){t.interceptors.push("userIsLoggedOutInterceptor"),n.setBaseUrl("/dhis/api")}]);
angular.module("d2-services").factory("schemaProcessor",function(){return function(s){var r,t=function(){this.schemas=[],this.schemaGroups={},this.getKlassGroupName=function(s){var r=s.split(".");return r[r.length-2]},this.addSchemasToGroups=function(s){var r=this,t={};return angular.forEach(s,function(s){var i=r.getKlassGroupName(s.klass);void 0===t[i]&&(t[i]=[]),t[i].push(s)}),this.schemaGroups=t,t},this.filterSchemasByPermissions=function(s){var r=[];return angular.forEach(this.schemas,function(t){t.isAuthorizedBy(s)&&r.push(t)}),r},this.process=function(s){this.schemas=s,angular.forEach(this.schemas,function(s){s.getPermissions=function(){var s={all:[]};return angular.forEach(this.authorities,function(r){"DELETE"===r.type?s.remove=r.authorities:s[r.type.toLowerCase()]=r.authorities,s.all=s.all.concat(r.authorities)}),s},s.isAuthorizedBy=function(r){var t=!1,i=s.getPermissions();return angular.forEach(i.all,function(a){r.indexOf(a)>=0&&(s.permissions=i,t=!0)}),t}})},this.getSchemaGroupsForPermissions=function(s){var r=this.filterSchemasByPermissions(s),t=this.addSchemasToGroups(r);return t},this.filterByGroupNames=function(s){var r=this.addSchemasToGroups(this.schemas),t={};return angular.forEach(s,function(s){r[s]&&(t[s]=r[s])}),t}};return r=new t,r.process(s||[]),r}});
var d2Settings=angular.module("d2-settings",["d2-rest"]);d2Settings.service("systemSettingsService",["d2Api",function(t){var e={};this.getAll=function(){return e},this.get=function(t){return e[t]},t.addEndPoint("systemSettings",!0),t.systemSettings.get().then(function(t){angular.extend(e,t.getDataOnly())})}]);
angular.module("d2-translate").factory("d2LanguageLoader",["$q","$http","translateApi",function(n,a,r){var t={};return function(e){var i=n.defer();return t[e.key]?(t[e.key]=angular.extend(r.apiTranslations,t[e.key]),i.resolve(angular.extend(r.apiTranslations,t[e.key]))):a.get("common/i18n/"+e.key+".json").success(function(n){t[e.key]=angular.extend(r.apiTranslations,n),i.resolve(t[e.key])}).error(function(){i.reject(e.key)}),i.promise}}]),angular.module("d2-translate").factory("d2MissingTranslationHandler",["$translate","translateApi",function(n,a){return function(n,r){a.add(n),a.translateThroughApi(r)}}]),angular.module("d2-translate").service("translateApi",["$q","$translate","apiConfig","$timeout","$http",function(n,a,r,t,e){var i=this,s=!1,o=[];this.apiTranslations={},this.add=function(n){angular.isString(n)&&""!==n.trim()&&(o.push(n.trim()),o=_.uniq(o))},this.getTranslationKeys=function(){var n=o;return o=[],n},this.getTranslationsFromApi=function(o){var u=n.defer();return s&&u.reject("waiting"),s=!0,t(function(){var n=i.getTranslationKeys();e.post(r.getUrl("i18n"),n).success(function(n){u.resolve(n)}).error(function(n){u.reject(n)}),a.refresh(o),s=!1},100,!1),u.promise},this.translateThroughApi=function(n){s===!1&&this.getTranslationsFromApi(n).then(function(n){i.apiTranslations=n,a.refresh()})}}]),angular.module("d2-translate").config(["$translateProvider",function(n){n.useLoader("d2LanguageLoader"),n.preferredLanguage("en"),n.useMissingTranslationHandler("d2MissingTranslationHandler")}]);
angular.module("d2-typeahead",[]),angular.module("d2-typeahead").service("typeAheadService",function(){this.add=function(a,e){if(!angular.isString(a))throw"Only string identifiers are allowed";if("get"===a||"add"===a)throw"Cannot override add or get methods";if(void 0!==e&&!angular.isArray(e))throw"Values should be an array";this[a]=_.uniq((this[a]||[]).concat(e))},this.get=function(a){return this[a]||[]}});
})(angular);
