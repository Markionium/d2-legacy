"use strict";
/*
 * Copyright (c) 2004-2014, University of Oslo
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are met:
 * Redistributions of source code must retain the above copyright notice, this
 * list of conditions and the following disclaimer.
 *
 * Redistributions in binary form must reproduce the above copyright notice,
 * this list of conditions and the following disclaimer in the documentation
 * and/or other materials provided with the distribution.
 * Neither the name of the HISP project nor the names of its contributors may
 * be used to endorse or promote products derived from this software without
 * specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND
 * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
 * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
 * DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR
 * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
 * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
 * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON
 * ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
 * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */
(function (angular, undefined) {
    var d2,d2Rest,d2Auth,d2Services,d2Filters,d2RecordTable,d2BreadCrumbs,d2IntroList,d2HeaderBar,d2Directives;d2={scriptPath:function(){var r;return function(){var d,e,a;return r?r:(a=angular.element('<script src=""></script>'),d=document.getElementsByTagName("script"),angular.forEach(d,function(r){/d2(\.min)?\.js$/i.test(r.src)&&(a=r)}),e=a.src||"",r=e.substring(0,e.lastIndexOf("/")+1))}}()},d2Rest=angular.module("d2-rest",["restangular"]),d2Auth=angular.module("d2-auth",["d2-rest"]),d2RecordTable=angular.module("d2-recordtable",["d2-filters","d2-typeahead"]),d2BreadCrumbs=angular.module("d2-breadcrumbs",[]),d2IntroList=angular.module("d2-introlist",[]),d2HeaderBar=angular.module("d2-headerbar",[]),d2Filters=angular.module("d2-filters",[]),angular.module("d2-directives",["d2-breadcrumbs","d2-introlist","d2-headerbar","d2-recordtable"]),d2Services=angular.module("d2-services",["d2-auth"]),angular.module("d2",["d2-services","d2-directives","d2-filters"]);
"use strict";d2Auth.service("currentUser",["d2Api",function(e){var t,n,s=this;this.userLoaded=!1,this.permissionsLoaded=!1,this.getPermissions=function(){return t},this.hasPermission=function(e){return n.indexOf(e)>0?!0:!1},e.currentUser.get().then(function(e){angular.extend(s,e.getDataOnly())}),t=e.currentUser.permissions.getList().then(function(e){return s.permissionsLoaded=!0,n=e.getDataOnly()})}]);
d2BreadCrumbs.directive("breadCrumbs",function(){return{restrict:"E",replace:!0,scope:!0,templateUrl:d2.scriptPath()+"common/breadcrumbs/breadcrumbs.html",controller:["$scope","breadCrumbsService",function(r,c){r.crumbClick=function(r){c.resetCrumbs(r.id),r.click&&r.click(angular.copy(r))},r.$watchCollection(function(){return c.getCrumbsList()},function(c){r.crumbsList=c})}]}});
d2BreadCrumbs.service("breadCrumbsService",function(){this.crumbsList=[],this.addCrumb=function(i,s){var t={};t.name=i,t.id=this.crumbsList.length,s&&angular.isFunction(s)&&(t.click=function(){return s()}),this.crumbsList.push(t)},this.resetCrumbs=function(i){void 0===i&&(i=0),this.crumbsList=_.filter(this.crumbsList,function(s){return s.id<=i})},this.getCrumbsList=function(){return this.crumbsList}});
d2Filters.filter("capitalize",function(){return function(r){return angular.isString(r)?r.charAt(0).toUpperCase()+r.slice(1):r}});
d2HeaderBar.directive("headerBar",function(){return{restrict:"E",replace:!0,transclude:!0,scope:{title:"@",link:"@",logo:"@",hasContent:"@"},templateUrl:d2.scriptPath()+"common/headerbar/headerbar.html",compile:function(e,t){t.title=t.title||"District Health Information Software 2",t.link=t.link||"../dhis-web-dashboard-integration/index.action",t.logo=t.logo||"../dhis-web-commons/css/light_blue/logo_banner.png"}}});
d2IntroList.directive("introList",function(){return{restrict:"E",replace:!0,scope:{itemList:"=",itemClick:"&"},templateUrl:d2.scriptPath()+"common/introlist/introlist.html",link:function(t){t.clickFunction=function(i){var n={item:angular.copy(i)};t.itemClick(n)}}}});
d2RecordTable.controller("RecordTableController",["$scope","$q","$filter","$timeout","typeAheadService",function(t,e,a,r,i){var n=this;this.localData=!0,this.origData=[],this.typeAheadCache=i,t.items=[],this.getHeadersFromData=function(){var e=[];return _.map(t.items,function(t){var a=t.getDataOnly?t.getDataOnly():t;return _.map(a,function(t,a){e.push({name:a})}),e}),e=_.uniq(e,function(t){return t.name}),t.columns=e,t.columns},this.parseTableConfig=function(){var e=t.tableConfig||{};return t.pageItems=e.pageItems,t.columns=e.columns||void 0,this},this.parseTableData=function(){return angular.isArray(t.tableData)&&void 0!==t.tableData.getList&&(this.localData=!1,t.d2Service=t.tableData,t.tableData=t.d2Service.getList(this.getRemoteParams())),e.when(t.tableData).then(this.processData.bind(this)),this},this.processData=function(e){return t.items=this.origData=e,t.columns=t.columns||this.getHeadersFromData(),t.pageItems&&(t.items=t.items.slice(0,t.pageItems)),angular.forEach(t.columns,function(t){n.typeAheadCache.add(t.name,n.getValuesForColumn(t))}),this},this.setSortOrder=function(e){var a=angular.copy(t.columns);angular.forEach(a,function(t){t.sort=t.name===e.name?"asc"===e.sort?"desc":"asc":void 0}),t.columns=a},this.getColumnsWithFilters=function(){return _.filter(t.columns,"searchable")},this.getFilterObject=function(){var t=this.getColumnsWithFilters(),e={};return 0===t.length?!1:(angular.forEach(t,function(t){e[t.name]=t.filter}),e)},this.getRemoteFilters=function(){var t=[];if(this.getFilterObject())return angular.forEach(this.getFilterObject(),function(e,a){e&&t.push(a+":like:"+e)}),t.length>0?t:void 0},this.getRemoteParams=function(){var t={},e=this.getRemoteFilters();return e&&(t.filter=e),e?t:void 0},this.requestNewDataFromService=function(){var a=this.getRemoteParams();t.tableData=t.d2Service.getList(a),e.when(t.tableData).then(this.processData.bind(this))},this.doLocalFiltering=function(){this.getFilterObject()&&(t.items=a("filter")(this.origData,this.getFilterObject()))},this.doLocalSorting=function(){var e,a=_.filter(t.columns,"sort"),r=_.pluck(a,"name");0!==a.length&&(e=_.sortBy(t.items,r),a[0]&&"desc"===a[0].sort&&(e=e.reverse()),t.items=e)},this.serviceSorting=function(){{var e=_.filter(t.columns,"sort");_.pluck(e,"name")}0!==e.length&&alert("API Sorting not yet implemented")},this.getValuesForColumn=function(e){return e&&e.name&&angular.isString(e.name)?_.map(t.items,function(t){return t[e.name]}):[]};var o=!1;t.$watch("columns",function(e,a){a!==e&&(n.localData&&(n.doLocalFiltering(),n.doLocalSorting()),t.d2Service&&(o||(r(function(){n.requestNewDataFromService(),o=!1},300),o=!0)))},!0)}]),d2RecordTable.directive("recordTable",function(){return{restrict:"E",replace:!0,scope:{tableConfig:"=",tableData:"="},templateUrl:d2.scriptPath()+"common/recordtable/recordtable.html",controller:"RecordTableController",link:function(t,e,a,r){r.parseTableConfig(),r.parseTableData()}}});
var recordTable=angular.module("d2-recordtable");d2RecordTable.directive("recordTableHeader",function(){return{restrict:"AC",replace:!0,require:"^recordTable",transclude:!0,scope:{column:"="},template:'<th class="table-header"><a ng-click="sortOrder()" href="#" ng-if="column.sortable" ng-transclude ng-class="\'sorting-\' + column.sort"></a><span ng-if="!column.sortable" ng-transclude></span><input ng-if="column.searchable" ng-model="column.filter" type="text" typeahead="name for name in getTypeAheadFor(column) | filter:$viewValue | limitTo:8"></th>',link:function(e,r,n,t){e.sortOrder=function(){t.setSortOrder(e.column)},e.getTypeAheadFor=function(e){return t.typeAheadCache[e.name]}}}});


"use strict";d2Rest.provider("d2Api",["RestangularProvider",function(t){var n=function(){this.indicators=this.all("indicators"),this.currentUser=this.one("me"),this.currentUser.permissions=this.one("me").all("authorization"),this.schemas=this.all("schemas"),this.addEndPoint=function(t,n){this[t]=n?this.one(t):this.all(t)}};this.setBaseUrl=function(t){this.config.setBaseUrl(t)},this.$get=["Restangular",function(t){var e;return e=n,e.prototype=t,new n}],this.config=t,this.config.addResponseInterceptor(function(t,n,e){if("getList"===n&&t&&t[e]){var i=t[e],r=angular.copy(t);return delete r[e],i.meta=r,i}return t}),this.config.setResponseExtractor(function(t){var n=t,e=angular.copy(t);return n.getDataOnly=function(){return e},n}),this.config.setOnElemRestangularized(function(t,n,e,i){return n||t.getDataOnly?t:angular.isString(t)?t:(t.getDataOnly=function(){var n=angular.copy(t);return n=i.stripRestangular(n),delete n.getDataOnly,n},t)})}]),d2Rest.config(["d2ApiProvider",function(t){t.setBaseUrl("/dhis/api")}]);
"use strict";d2Services.factory("schemaProcessor",function(){return function(s){var r=new function(){this.schemas=[],this.schemaGroups={},this.getKlassGroupName=function(s){var r=s.split(".");return r[r.length-2]},this.addSchemasToGroups=function(s){var r=this,t={};return angular.forEach(s,function(s){var i=r.getKlassGroupName(s.klass);void 0===t[i]&&(t[i]=[]),t[i].push(s)}),this.schemaGroups=t,t},this.filterSchemasByPermissions=function(s){var r=[];return angular.forEach(this.schemas,function(t){t.isAuthorizedBy(s)&&r.push(t)}),r},this.process=function(s){this.schemas=s,angular.forEach(this.schemas,function(s){s.getPermissions=function(){var s={all:[]};return angular.forEach(this.authorities,function(r){"DELETE"===r.type?s.remove=r.authorities:s[r.type.toLowerCase()]=r.authorities,s.all=s.all.concat(r.authorities)}),s},s.isAuthorizedBy=function(r){var t=!1,i=s.getPermissions();return angular.forEach(i.all,function(a){r.indexOf(a)>=0&&(s.permissions=i,t=!0)}),t}})},this.getSchemaGroupsForPermissions=function(s){var r=this.filterSchemasByPermissions(s),t=this.addSchemasToGroups(r);return t},this.filterByGroupNames=function(s){var r=this.addSchemasToGroups(this.schemas),t={};return angular.forEach(s,function(s){r[s]&&(t[s]=r[s])}),t}};return r.process(s||[]),r}});
"use strict";var d2TypeAhead=angular.module("d2-typeahead",[]);d2TypeAhead.service("typeAheadService",function(){this.add=function(e,t){if(!angular.isString(e))throw"Only string identifiers are allowed";if("get"===e||"add"===e)throw"Cannot override add or get methods";if(void 0!==t&&!angular.isArray(t))throw"Values should be an array";this[e]=_.uniq((this[e]||[]).concat(t))},this.get=function(e){return this[e]||[]}});
})(angular);
